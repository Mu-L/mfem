# Copyright (c) 2010, Lawrence Livermore National Security, LLC. Produced at
# the Lawrence Livermore National Laboratory. LLNL-CODE-443211. All Rights
# reserved. See file COPYRIGHT for details.
#
# This file is part of the MFEM library. For more information and source code
# availability see http://mfem.org.
#
# MFEM is free software; you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License (as published by the Free
# Software Foundation) version 2.1 dated February 1999.


# GitLab pipelines configurations for the Quart machine at LLNL

.quartz_common:
    tags:
        - shell
        - quartz
    variables:
        PLAT: quartz
        MPIEXEC: srun
        MPIEXEC_NP: "-n"

# Pre-Cleanup
quartz_precleanup:
    extends: [.quartz_common, .precleanup]

# Setup
quartz_setup:
    extends: [.quartz_common, .setup]

# Allocate
quartz_allocate:
    variables:
        GIT_STRATEGY: none
    extends: .quartz_common
    stage: allocate
    script:
        - |
          if [[ "${MPIEXEC}" == "srun" ]]
          then
              salloc -N 1 -c 36 -p pdebug -t 30 --no-shell --job-name=${MFEM_ALLOC_NAME}
          fi

# Release
quartz_deallocate:
  variables:
    GIT_STRATEGY: none
  extends: .quartz_common
  stage: deallocate
  script:
      - |
        if [[ "${MPIEXEC}" == "srun" ]]
        then
            export JOB_ID=$(squeue -h --name=${MFEM_ALLOC_NAME} --format=%A)
            ([[ -n "${JOB_ID}" ]] && scancel ${JOB_ID})
        fi
  when: always

# Build external libraries (tpls)
quartz_build_hypre_gcc_6_1_0:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_hypre]

quartz_build_parmetis_gcc_6_1_0:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_metis]
    variables:
        METIS: parmetis

quartz_build_metis4_gcc_6_1_0:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_metis]
    variables:
        METIS: metis4

quartz_build_metis5_gcc_6_1_0:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_metis]
    variables:
        METIS: metis5
    allow_failure: true

# Build MFEM
quartz_build_mfem_gcc_4_9_3_debug_ser:
    extends: [.quartz_common, .with_gcc_4_9_3, .build_mfem]
    variables:
        MFEM_DEBUG: "YES"
        MFEM_USE_MPI: "NO"

quartz_build_mfem_gcc_6_1_0_debug_ser:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_mfem]
    variables:
        MFEM_DEBUG: "YES"
        MFEM_USE_MPI: "NO"

quartz_build_mfem_gcc_6_1_0_debug_par:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_mfem]
    variables:
        MFEM_DEBUG: "YES"
        MFEM_USE_MPI: "YES"
    needs: [quartz_build_hypre_gcc_6_1_0, quartz_build_parmetis_gcc_6_1_0, quartz_allocate]

quartz_build_mfem_gcc_6_1_0_opt_ser:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_mfem]
    variables:
        MFEM_DEBUG: "NO"
        MFEM_USE_MPI: "NO"

quartz_build_mfem_gcc_6_1_0_opt_par:
    extends: [.quartz_common, .with_gcc_6_1_0, .build_mfem]
    variables:
        MFEM_DEBUG: "NO"
        MFEM_USE_MPI: "YES"
    needs: [quartz_build_hypre_gcc_6_1_0, quartz_build_parmetis_gcc_6_1_0, quartz_allocate]

### Tests

# Sanity check
quartz_sanitycheck_mfem_gcc_4_9_3_debug_ser:
    extends: [.quartz_common, .with_gcc_4_9_3, .sanitycheck_mfem]
    variables:
        MFEM_DEBUG: "YES"
        MFEM_USE_MPI: "NO"
    needs: [quartz_build_mfem_gcc_4_9_3_debug_ser, quartz_allocate]

quartz_sanitycheck_mfem_gcc_6_1_0_debug_ser:
    extends: [.quartz_common, .with_gcc_6_1_0, .sanitycheck_mfem]
    variables:
        MFEM_DEBUG: "YES"
        MFEM_USE_MPI: "NO"
    needs: [quartz_build_mfem_gcc_6_1_0_debug_ser, quartz_allocate]

quartz_sanitycheck_mfem_gcc_6_1_0_opt_ser:
    extends: [.quartz_common, .with_gcc_6_1_0, .sanitycheck_mfem]
    variables:
        MFEM_DEBUG: "NO"
        MFEM_USE_MPI: "NO"
    needs: [quartz_build_mfem_gcc_6_1_0_opt_ser, quartz_allocate]

quartz_sanitycheck_mfem_gcc_6_1_0_opt_par:
    extends: [.quartz_common, .with_gcc_6_1_0, .sanitycheck_mfem]
    variables:
        MFEM_DEBUG: "NO"
        MFEM_USE_MPI: "YES"
    needs: [quartz_build_mfem_gcc_6_1_0_opt_par, quartz_allocate]

# Baseline
quartz_baselinecheck_mfem_gcc_6_1_0:
    extends: [.quartz_common, .with_gcc_6_1_0, .baselinecheck_mfem]

quartz_baselinepublish_mfem:
    extends: [.quartz_common, .rebaseline_mfem]

# Post-Cleanup
quartz_postcleanup:
    extends: [.quartz_common, .postcleanup]
